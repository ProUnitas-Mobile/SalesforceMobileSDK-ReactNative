$device = ENV.has_key?('DEVICE') ? ENV['DEVICE'] : 'iPhone-SE-3rd-generation'
$ios = ENV.has_key?('IOS_VERSION') ? ENV['IOS_VERSION'] : '15.5'

lane :build do
    analyze_scheme("SalesforceReactTestApp")
end

lane :test do
    test_scheme("SalesforceReactTestApp")
end

def test_scheme(scheme)
    scan(
        workspace: '../iosTests/ios/SalesforceReactTestApp.xcworkspace',
        scheme: scheme,
        device:  ENV['DEVICE'] + ' (' + ENV['IOS_VERSION'] + ')',
        output_directory: './test_output',
        output_types: 'html,junit',
        code_coverage: true,
        skip_build: true,
        ensure_devices_found: true
    )
end

def analyze_scheme(scheme)
    xcodebuild(
        xcargs: 'CLANG_ANALYZER_OUTPUT=plist-html CLANG_ANALYZER_OUTPUT_DIR=./clangReport RUN_CLANG_STATIC_ANALYZER=YES ARCHS=x86_64',
        workspace: '../iosTests/ios/SalesforceReactTestApp.xcworkspace',
        scheme: scheme,
        sdk: 'iphonesimulator',
    )
end